# IoT-test-postman/test-stand

## Стурктура директории
В данной директории содержится:

1. Папка libraries. Там лежат подключаемые библиотеки (генераторы отчетов, симуляторы и т.д.)

2. config.json. Это конфиг стенда для автотестов. Тут указываются адреса, порты, параметры запуска стенда, а также пути.

3. install.sh. Это скрипт для установки/обновеления библиотек необходимых для корректного функционирования стенда.

4. js_start.mjs. Этот скрипт необходим для запуска тестов. Данный скрипт:
    
    4.1. Читает переданный при запуске конфиг.

    4.2. Определяет текущую дату и время.

    4.3. Заменяет значения глобальных переменных Postman для host на адрес платформы из конфига, а websocket_proxy_host и zway_ctl_host на localhost, так как скрипт запускает их локально.

    4.4. Определяет версию и тип платформы (IoT-Core или SL-10).

    4.5. Создает папку для отчета.

    4.6. Запускает все утилиты для тестирования.

    4.7. Запускает тест

    4.8. Останавливает все звпущенные ранее утилиты.

    4.9. Вставляет в отчет allure переменные из окружения (environment).

    4.10. Генерирует отчет Allure.

    4.11. Мелкие модификации отчетов (вставить версию платформы в отчеты, количество проверок и т.д.).

    4.12. Копирует отчет в директорию откуда её можно посмотреть через http сервер.

    4.13. Сжимает отчет который вернется в ansible (а в последствии и в артефакты шага с тестами).

    4.14. Возвращает exitCode (1 если тесты провалились).

5. package.json. Файл с указанием зависимостей стенда.

6. report-template.hbs. Файл необходимый для генерации html отчета.

7. runner. Этот скрипт запускается в ci/cd в шаге запускающем тесты. Данный скрипт принимет в себя входные параметры CI_JOB_TOKEN и CI_COMMIT_BRANCH. Далее данный скрипт:
    
    7.1. Удаляет старый стенд.

    7.2. Стягивает стенд из данного репозитория.

    7.3. Запускает скрипт install.sh с флагом --update.

    7.4. Запускает скрипт для старта тестов js_start.mjs и передает туда конфигурацию config.json.

    7.5. Ожидает завершения js_start.mjs, по завершению принимет exit_code.

    7.6. Запускает скрипт postman-swagger-coverage для генерации покрытия API тестами.
    
    7.7. Завершается с ранее сохраненным exit_code
