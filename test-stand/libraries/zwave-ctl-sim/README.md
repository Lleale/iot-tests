# Симулятор Z-Wave контроллера

# Содержание
- [Установка и запуск](#установка-и-запуск)
- [HTTP запросы](#http-запросы)
    - [Управление контроллером](#управление-контроллером)
        - [Получение информации о контроллере](#получение-информации-о-контроллере)
        - [Обновление информации о контроллере](#обновление-информации-о-контроллере)
        - [Подключение к платформе](#подключение-к-платформе)
        - [Отключение от платформы](#отключение-от-платформы)
    - [Управление устройствами](#управление-устройствами)
        - [Добавление устройства](#добавление-устройства)
        - [Удаление устройства](#удаление-устройства)
        - [Изменение значения проперти](#изменение-значения-проперти)
        - [Изменение статуса FLiRS](#изменение-статуса-flirs)
        - [Изменение периода опроса](#изменение-периода-опроса)
        - [Изменение состояния устройства по питанию](#изменение-состояния-устройства-по-питанию)
        - [Изменение информации об устройстве](#изменение-информации-об-устройстве)
- [Сущности](#сущности)
    - [ZWaveController](#zwavecontroller)
    - [ZWaveDevice](#zwavedevice)
    - [Property](#property)
    - [GuardMode](#guardmode)
    - [SecurityType](#securitytype)
    - [ProbeType](#probetype)

# Установка и запуск
Для работы симулятора требуется Node v16+, а также ts-node:<br>
`sudo npm install -g ts-node`

После этого необходимо в папке с симулятор запустить команду:<br>
`npm install`

Запуск симулятора осуществляется командой:<br>
`node --loader ts-node/esm ./src/index.ts`

# HTTP запросы
## Управление контроллером

### Получение информации о контроллере
**Запрос:** GET `{host}/ctl/info`

**Тело ответа (JSON):** Сущность [ZWaveController](#zwavecontroller)

---
### Обновление информации о контроллере
**Запрос:** POST `{host}/ctl/info`

**Тело запроса (JSON):** Сущность [ZWaveController](#zwavecontroller). Неопределенные поля будут иметь предыдущее значение.

**Тело ответа (JSON):** Сущность [ZWaveController](#zwavecontroller)

---
### Подключение к платформе
**Запрос:** POST `{host}/ctl/connect`

**Тело запроса (JSON):** 
|Поле|Описание|
|---|---|
|host|Адрес платформы|
|port|Порт для подключения к платформе|
|type|Протокол подключения к платформе<br>(для облака - `o7`, для локальной платформы - `glcp`)|
|allowMultiple|Если `true`, то уже открытые соединения остануться открыты, иначе они закроются при открытии нового.<br>(опционально, по-умолчанию - `false`)|

**Тело ответа (JSON):** Сущность [ZWaveController](#zwavecontroller)

---
### Отключение от платформы
**Запрос:** POST `{host}/ctl/disconnect`

**Тело запроса (JSON):** 
|Поле|Описание|
|---|---|
|host|Фильтр по адресу платформы<br>(опционально)|
|port|Фильтр по порту<br>(опционально)|
|type|Фильтр по протоколу подключения<br>(опционально, для облака - `o7`, для локальной платформы - `glcp`)|

**Тело ответа (JSON):** Сущность [ZWaveController](#zwavecontroller)

## Управление устройствами

### Добавление устройства
**Запрос:** POST `{host}/devices/add`

**Тело запроса (JSON):** Сущность [ZWaveDevice](#zwavedevice).<br>
Можно добавить поле `template` для создания устройства по шаблону.<br>
Доступные шаблоны находятся в папке `devices`, используются имена файлов оттуда **без** расширения.

**Тело ответа (JSON):** Сущность [ZWaveDevice](#zwavedevice)

---
### Удаление устройства
**Запрос:** DELETE `{host}/devices/{nodeId}`

**Тело ответа (JSON):** отсутствует

---
### Изменение значения проперти
**Запрос:** POST `{host}/devices/{nodeId}/prop/{endpoint}/{probeType}`

**Тело запроса (JSON):** 
|Поле|Описание|
|---|---|
|value|Новое значение проперти<br>(если это число, то при отправке по протоколу GLCP оно будет умножено на 100)|
|rule|Условие установки новго значения.<br>Например, условие `guardMode:2` применит новое значение проперти тогда, когда начнется инициализация FLiRS.<br>Последующие запросы на изменение значения проперти отменяют эти условия.|

**Тело ответа (JSON):** Сущность [Property](#property)

---
### Изменение статуса FLiRS
**Запрос:** POST `{host}/devices/{nodeId}/guard_mode`

**Тело запроса (JSON):** 
|Поле|Описание|
|---|---|
|value|Новое значение статуса FLiRS<br>(сущность [GuardMode](#guardmode))|

**Тело ответа (JSON):** Сущность [ZWaveDevice](#zwavedevice)

---
### Изменение периода опроса
**Запрос:** POST `{host}/devices/{nodeId}/keep_alive`

**Тело запроса (JSON):** 
|Поле|Описание|
|---|---|
|value|Новый период опроса|

**Тело ответа (JSON):** Сущность [ZWaveDevice](#zwavedevice)

---
### Изменение состояния устройства по питанию
**Запрос:** POST `{host}/devices/{nodeId}/power`

**Тело запроса (JSON):** 
|Поле|Описание|
|---|---|
|value|Новое состояние устройства.<br>`true` - включено, `false` - выключено|

**Тело ответа (JSON):** Сущность [ZWaveDevice](#zwavedevice)

---
### Изменение информации об устройстве
**Запрос:** PATCH `{host}/devices/{nodeId}`

**Тело запроса (JSON):** Поля `guardInitDelay`, `batteryVoltage` и `properties` из сущности [ZWaveDevice](#zwavedevice). Все остальные поля игнорируются.

**Тело ответа (JSON):** Сущность [ZWaveDevice](#zwavedevice)

# Сущности
### ZWaveController
Информация о контроллере
|Поле|Описание|
|---|---|
|vendor|Произвдоитель контроллера|
|homeId|HomeID контроллера<br>(не имеет значения, т.к. никаких реальных взаимодействий с эфиром не происходит)|
|zWaveVersion|Версия субмодуля Z-Wave|
|mac|MAC-адрес контроллера|
|serial|Серийный номер контроллера|
|version|Версия ПО контроллера|
|model|Модель контроллера<br>(отображается в качестве имени по-умолчанию)|
|devices[]|Список устройств, симулируемых контроллером<br>(сущности [ZWaveDevice](#zwavedevice))|
|interfaces[]|Активные подключения к платформам в формате `{protocol}://{host}:{port}`|

### ZWaveDevice
Информация об устройстве
|Поле|Описание|
|---|---|
|nodeId|NodeID устройства, должен быть уникальным в рамках одного контроллера|
|security|Стандарт безопасности<br>(сущность [SecurityType](#securitytype))|
|version|Версия устройства|
|properties[]|Список проперти устройства<br>(сущность [Property](#property))|
|batteryVoltage|Напряжение на батарейке устройства<br>(значения ниже 0 означают отсутствие батареи)|
|poweredOn|Состояние питания устройства|
|guardMode|Статус FLiRS<br>(сущность [GuardMode](#guardmode))|
|keepAlivePeriod|Период опроса датчика<br>(только для отображения на платформе, не влияет на работу симулятора)|
|guardInitDelay|Задержка от инициализации до включения FLiRS<br>(в миллисекундах)|
|dsk|DSK устройства|
|manufacturerId|ID производителя устройства<br>(например, 923 - это Eltex)|
|productId|ID продукта устройства|
|productName|Название продукта устройства<br>(обычно "unknown")|
|productTypeId|ID типа продукта устройства|

### Property
Информация о проперти устройства
|Поле|Описание|
|---|---|
|endpoint|Номер канала|
|deviceType|Тип устройства, определяет возможные значения для облачной платформы.<br>Например, `switchBinary`, `sensorBinary` и т.д.|
|model|Вид проперти<br>(сущность [ProbeType](#probetype))|
|value|Текущее значение проперти|

### GuardMode
Статус FLiRS
|Значение|Описание|
|---|---|
|-1|Отсутствует|
|0|Включен|
|1|Выключен|
|2|Инициализация|
|3|Ошибка|

### SecurityType
Стандарт безопасности
|Значение|Описание|
|---|---|
|insecure|Небезопасное устройство|
|s0|Z-Wave S0 Security (без DSK)|
|s2|Z-Wave S2 Security (с DSK)|

### ProbeType
Вид проперти
|Значение|Описание|
|---|---|
|tamper|Датчик вскрытия устройства|
|openClose|Датчик открытия<br>(например, двери или окна)|
|motion|Датчик движения|
|glassBreak|Датчик разбития стекла|
|smoke|Датчик дыма|
|waterLeak|Датчик протечки|
|co2|Датчик CO2|
|voc|Датчик летучей органики|
|humidity|Датчик влажности|
|temperature|Датчик температуры|